
<!doctype html>
<html lang="en">
<head>
	<title>Video Texture (Three.js)</title>
	<meta charset="utf-8">
	<!--<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"> -->
	<!--<link rel=stylesheet href="css/base.css"/>-->
	
        <style>
        * {
            height: 100%;
  margin: 0;
  padding: 0;
  background: #000000;
  color: #000;
            overflow: hidden;
          }
          
#viewer {
  position: absolute;
  top: 0;
  left: 0;
}
        </style>
        <script src="js/Three.js"></script>
<script src="js/Detector.js"></script>
<!--<script src="js/Stats.js"></script>
<script src="js/OrbitControls.js"></script>-->
<script src="js/THREEx.KeyboardState.js"></script>
<script src="js/THREEx.FullScreen.js"></script>
<script src="js/THREEx.WindowResize.js"></script>

<!--Oculus Rift Support-->

<script src="js/OculusRiftEffect.js"></script>
<script src="js/vr.js"></script>
<script src="js/gamepad.js"></script>

<!--Oculus Rift Support-->

<script src="js/html2canvas.js"></script>
<script src="js/rasterizeHTML.allinone.js"></script>
<!-- jQuery code to display an information button and box when clicked. -->
<script src="js/jquery-1.9.1.js"></script>
<script src="js/jquery-ui.js"></script>
<!-- <link rel=stylesheet href="css/jquery-ui.css" />
<link rel=stylesheet href="css/info.css"/> -->
<script src="js/info.js"></script>
<!-- ------------------------------------------------------------ -->

<!-- <div id="ThreeJS" style="position: absolute; left:0px; top:0px"></div> -->
<script>
/*
	some of the code is from...
	Three.js "tutorials by example"
	Author: Lee Stemkoski
	Date: July 2013 (three.js v59dev)
*/
	
// MAIN

// standard global variables
var container, scene, camera, renderer, controls, stats;
var keyboard = new THREEx.KeyboardState();

// custom global variables
var video, videoImage, videoImageContext, videoTexture;

var riftEffect;

var render=menuRender;

var update=videoUpdate;

var menuDiv, menuCanvas, menuImageContext, menuTexture;

var menuIndex=0;
var BASE_MENU=[{name:'movies', action:function(){gotoMenu(MOVIE_MENU);}},
				{name:'flight map', action:showMap},
				{name:'games', action:function(){gotoMenu(GAMES_MENU);}}];
var menuState = BASE_MENU;
var MOVIE_MENU=[];
var GAMES_MENU=[];


var MOUSE_SPEED = 0.005;
var KEYBOARD_SPEED = 0.02;
var GAMEPAD_SPEED = 0.04;
var DEADZONE = 0.2;

var WORLD_FACTOR = 1.0;
var OculusRift = {
  // Parameters from the Oculus Rift DK1
  hResolution: 1280,
  vResolution: 800,
  hScreenSize: 0.14976,
  vScreenSize: 0.0936,
  interpupillaryDistance: 0.064,
  lensSeparationDistance: 0.064,
  eyeToScreenDistance: 0.041,
  distortionK : [1.0, 0.22, 0.24, 0.0],
  chromaAbParameter: [ 0.996, -0.004, 1.014, 0.0]
};

var headingVector = new THREE.Vector3();
var moveVector = new THREE.Vector3();
var keyboardMoveVector = new THREE.Vector3();
var gamepadMoveVector = new THREE.Vector3();
var HMDRotation = new THREE.Quaternion();
var BaseRotation = new THREE.Quaternion();
var BaseRotationEuler = new THREE.Vector3();

var VRState = null;


// Utility function
// ----------------------------------------------
function angleRangeDeg(angle) {
  angle %= 360;
  if (angle < 0) angle += 360;
  return angle;
}

function angleRangeRad(angle) {
  angle %= 2*Math.PI;
  if (angle < 0) angle += 2*Math.PI;
  return angle;
}

function deltaAngleDeg(a,b) {
  return Math.min(360-(Math.abs(a-b)%360),Math.abs(a-b)%360);
}

function deltaAngleRas(a,b) {
  // todo
}

// gogo api
function requestBoth(callback)
{
requestCurrentFlight(function(data){requestInfoForTailNo(tailNo, callback)});
}

function requestCurrentFlight(callback)
{
var oReq = new XMLHttpRequest();

oReq.onload = function(){callback(JSON.parse(this))};
oReq.open("get", "http://jsonp.jit.su/?url=https%3A%2F%2Fapi.gogoair.com%2Fv1%2Ftest%2Faal%2Fstatustray%3Fapikey%3DLoB9jsKwwpye2HfdGp3ds7rbMGYuj6rA", true);
oReq.send();
"http://jsonp.jit.su/?url=https%3A%2F%2Fapi.gogoair.com%2Fv1%2Faircraft%2Ftailno%2F"+tailNo+"%3Fapikey%3DLoB9jsKwwpye2HfdGp3ds7rbMGYuj6rA"
}

function requestInfoForTailNo(tailNo, callback)
{
var oReq = new XMLHttpRequest();
oReq.onload = function(){callback(JSON.parse(this))};
oReq.open("get", "http://jsonp.jit.su/?url=https%3A%2F%2Fapi.gogoair.com%2Fv1%2Ftest%2Faal%2Fstatustray%3Fapikey%3DLoB9jsKwwpye2HfdGp3ds7rbMGYuj6rA", true);
oReq.send();
}

function showMap()
{
}

function gotoMenu(menu)
{
	if(menu && typeof(menu)!=='undefined' && menu!==menuState)
	{
		menuState=menu;
		menuIndex=0;
	}
	
	if(menuState.length<=0) menuIndex=0;
	else menuIndex=((menuIndex%menuState.length)+menuState.length)%menuState.length;
	
	menuImageContext.fillStyle = '#ffffff';
	menuImageContext.fillRect( 0, 0, menuCanvas.width, menuCanvas.height );

	//menuTexture.minFilter = THREE.LinearFilter;
	//menuTexture.magFilter = THREE.LinearFilter;
	//	menuImageContext.drawImage(,0,0);
	for(i=0; i<menuState.length; i++)
	{
		menuImageContext.fillStyle = '#000000';
		if(i==menuIndex) menuImageContext.font="bold 120px Georgia";
		else menuImageContext.font="120px Georgia";
        menuImageContext.textAlign = 'center';
		menuImageContext.fillText(menuState[i].name, menuCanvas.width/2,120*(i+1));
	}
	menuTexture.needsUpdate=true;
}

// FUNCTIONS 		
function init() 
{
	initVR();
	initControls();
	// SCENE
	scene = new THREE.Scene();
	// CAMERA
	
	var SCREEN_WIDTH = document.body.clientWidth, SCREEN_HEIGHT = document.body.clientHeight;
	var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;
	camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
	scene.add(camera);
	camera.position.set(0,150,400);
	camera.lookAt(scene.position);	
	// RENDERER
	if ( Detector.webgl )
		renderer = new THREE.WebGLRenderer( {antialias:true} );
	else
		renderer = new THREE.CanvasRenderer(); 
	renderer.setSize(window.innerWidth, window.innerHeight);
	
	//Now the rift effect
	OculusRift.hResolution = window.innerWidth, OculusRift.vResolution = window.innerHeight,



	 riftEffect = new THREE.OculusRiftEffect( renderer, { HMD:OculusRift, worldFactor:1.0} );
	 riftEffect.setSize(window.innerWidth, window.innerHeight ); 

	// container = document.getElementById( 'ThreeJS' );
	  var viewer = $('#viewer');
  	viewer.append(renderer.domElement);
	// CONTROLS
	//controls = new THREE.OrbitControls( camera, renderer.domElement );
	// EVENTS
	THREEx.WindowResize(renderer, camera);
	THREEx.FullScreen.bindKey({ charCode : 'm'.charCodeAt(0) });
	// STATS
//	stats = new Stats();
//	stats.domElement.style.position = 'absolute';
//	stats.domElement.style.bottom = '0px';
//	stats.domElement.style.zIndex = 100;
//	container.appendChild( stats.domElement );
	// LIGHT
	var light = new THREE.PointLight(0xffffff);
	light.position.set(0,250,0);
	scene.add(light);
	// FLOOR
	var floorTexture = new THREE.ImageUtils.loadTexture( 'images/checkerboard.jpg' );
	floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; 
	floorTexture.repeat.set( 10, 10 );
	var floorMaterial = new THREE.MeshBasicMaterial( { map: floorTexture, side: THREE.DoubleSide } );
	var floorGeometry = new THREE.PlaneGeometry(1000, 1000, 10, 10);
	var floor = new THREE.Mesh(floorGeometry, floorMaterial);
	floor.position.y = -0.5;
	floor.rotation.x = Math.PI / 2;
	//scene.add(floor);
	// SKYBOX/FOG
	var skyBoxGeometry = new THREE.CubeGeometry( 10000, 10000, 10000 );
	//var skyBoxMaterial = new THREE.MeshBasicMaterial( { color: 0x9999ff, side: THREE.BackSide } );
	
	    var materials = [
       new THREE.MeshLambertMaterial({
           map: THREE.ImageUtils.loadTexture('/images/px.jpg'), side:THREE.DoubleSide 
       }),
       new THREE.MeshLambertMaterial({
           map: THREE.ImageUtils.loadTexture('/images/py.jpg'), side:THREE.DoubleSide 
       }),
       new THREE.MeshLambertMaterial({
           map: THREE.ImageUtils.loadTexture('/images/pz.jpg'), side:THREE.DoubleSide 
       }),
       new THREE.MeshLambertMaterial({
           map: THREE.ImageUtils.loadTexture('/images/px.jpg'), side:THREE.DoubleSide 
       }),
       new THREE.MeshLambertMaterial({
           map: THREE.ImageUtils.loadTexture('/images/py.jpg'), side:THREE.DoubleSide 
       }),
       new THREE.MeshLambertMaterial({
           map: THREE.ImageUtils.loadTexture('/images/pz.jpg'), side:THREE.DoubleSide 
       }),
    ];
	var skyBoxMaterial = new THREE.MeshFaceMaterial( materials ) 
	var skyBox = new THREE.Mesh( skyBoxGeometry, skyBoxMaterial );
	scene.add(skyBox);
	scene.fog = new THREE.FogExp2( 0x9999ff, 0.00025 );
	
	
	///////////
	// VIDEO //
	///////////
	
	// create the video element
	video = document.createElement( 'video' );
	// video.id = 'video';
	// video.type = ' video/ogg; codecs="theora, vorbis" ';
	
	//set up thingi
	
	// alternative method -- 
	// create DIV in HTML:
	// <video id="myVideo" autoplay style="display:none">
	//		<source src="videos/sintel.ogv" type='video/ogg; codecs="theora, vorbis"'>
	// </video>
	// and set JS variable:
	// video = document.getElementById( 'myVideo' );
	
	videoImage = document.createElement( 'canvas' );
	videoImage.width = 480;
	videoImage.height = 204;

	videoImageContext = videoImage.getContext( '2d' );
	// background color if no video present
	videoImageContext.fillStyle = '#000000';
	videoImageContext.fillRect( 0, 0, videoImage.width, videoImage.height );

	videoTexture = new THREE.Texture( videoImage );
	videoTexture.minFilter = THREE.LinearFilter;
	videoTexture.magFilter = THREE.LinearFilter;
	
		
	///////////
	// MENU  //
	///////////
	
	menuCanvas = document.createElement( 'canvas' );
	menuCanvas.width = 1920;
	menuCanvas.height = 1080;
	menuTexture = new THREE.Texture(menuCanvas); //new THREE.ImageUtils.loadTexture( 'images/checkerboard.jpg' );
	
	menuImageContext = menuCanvas.getContext( '2d' );
	// background color if no video present
	gotoMenu(BASE_MENU);
	menuTexture.needsUpdate=true;

	var movieMaterial = new THREE.MeshBasicMaterial( { map: menuTexture, overdraw: true, side:THREE.DoubleSide } );
	// the geometry on which the movie will be displayed;
	// 		movie image will be scaled to fit these dimensions.
	var movieGeometry = new THREE.PlaneGeometry(1920/2, 1080/2, 4, 4 );
	var movieScreen = new THREE.Mesh( movieGeometry, movieMaterial );
	movieScreen.position.set(0,1080/4,0);
	scene.add(movieScreen);
	
	camera.position.set(0,1080/4,300);
	camera.lookAt(movieScreen.position);
				
	
}

function setUpVideo()
{
	movieMaterial.map=videoTexture;
	
	video.src = "videos/sintel.ogv";
	video.load(); // must call after setting/changing source
	video.play();
}

function setUpMenu()
{
	movieMaterial.map=menuTexture;
	
}

function videoUpdate()
{
	if ( keyboard.pressed("p") )
		video.play();
		
	if ( keyboard.pressed("space") )
		video.pause();

	if ( keyboard.pressed("s") ) // stop video
	{
		video.pause();
		video.currentTime = 0;
	}
	
	if ( keyboard.pressed("r") ) // rewind video
		video.currentTime = 0;
	
	//controls.update();
	//stats.update();
}

function videoRender() 
{	
	if ( video.readyState === video.HAVE_ENOUGH_DATA ) 
	{
		videoImageContext.drawImage( video, 0, 0 );
		if ( videoTexture ) 
			videoTexture.needsUpdate = true;
	}

	//renderer.render( scene, camera );
	riftEffect.render( scene, camera );
};

function menuRender()
{
				menuTexture.needsUpdate = true;
	riftEffect.render( scene, camera );
};

function animate() 
{
    requestAnimationFrame( animate );
  if (VRState !== null) {
    if (vr.pollState(VRState)) {
      HMDRotation.set(VRState.hmd.rotation[0], VRState.hmd.rotation[1], VRState.hmd.rotation[2], VRState.hmd.rotation[3]);
    }
  }

  // Compute move vector
  moveVector.addVectors(keyboardMoveVector, gamepadMoveVector);


  // Apply movement
  BaseRotationEuler.set( angleRangeRad(BaseRotationEuler.x + moveVector.x), angleRangeRad(BaseRotationEuler.y + moveVector.y), 0.0 );
  tempEuler=new THREE.Euler( BaseRotationEuler.x, BaseRotationEuler.y, BaseRotationEuler.z, 'XYZ' );
  BaseRotation.setFromEuler(tempEuler);

  // Update camera rotation
  camera.quaternion.multiplyQuaternions(BaseRotation, HMDRotation);
	render();		
	update();
}

window.addEventListener( 'resize', resize, false );

function resize( event ) {
	//Now the rift effect
	OculusRift.hResolution = window.innerWidth, OculusRift.vResolution = window.innerHeight,
	 riftEffect = new THREE.OculusRiftEffect( renderer, { HMD:OculusRift, worldFactor:1.0} );
	 riftEffect.setSize(window.innerWidth, window.innerHeight ); 
  riftEffect.setSize(window.innerWidth,window.innerHeight);
  renderer.setSize(window.innerWidth,window.innerHeight);
  camera.projectionMatrix.makePerspective( 60, window.innerWidth/window.innerHeight, 1, 1100 );
}



function initControls() {

  // Keyboard
  // ---------------------------------------
  var lastSpaceKeyTime = new Date(),
      lastCtrlKeyTime = lastSpaceKeyTime;

  $(document).keydown(function(e) {
    //console.log(e.keyCode);
    switch(e.keyCode) {
      case 32: // Space
        var spaceKeyTime = new Date();
        if (spaceKeyTime-lastSpaceKeyTime < 300) {
          $('.ui').toggle(200);
        }
        lastSpaceKeyTime = spaceKeyTime;
        break;
      case 37:
        keyboardMoveVector.y = KEYBOARD_SPEED;
        break;
      case 38:
        keyboardMoveVector.x = KEYBOARD_SPEED;
        break;
      case 39:
        keyboardMoveVector.y = -KEYBOARD_SPEED;
        break;
      case 40:
        keyboardMoveVector.x = -KEYBOARD_SPEED;
        break;
      case 17: // Ctrl
        var ctrlKeyTime = new Date();
        if (ctrlKeyTime-lastCtrlKeyTime < 300) {
          moveToNextPlace();
        }
        lastCtrlKeyTime = ctrlKeyTime;
        break;
      case 18: // Alt
        USE_DEPTH = !USE_DEPTH;
        $('#depth-left').prop('checked', USE_DEPTH);
        $('#depth-right').prop('checked', USE_DEPTH);
        setSphereGeometry();
        break;
    }
  });

  $(document).keyup(function(e) {
    switch(e.keyCode) {
      case 37:
      case 39:
        keyboardMoveVector.y = 0.0;
        break;
      case 38:
      case 40:
        keyboardMoveVector.x = 0.0;
        break;
    }
  });

  // Mouse
  // ---------------------------------------
  var viewer = $('#viewer'),
      mouseButtonDown = false,
      lastClientX = 0,
      lastClientY = 0;

  viewer.dblclick(function() {
    moveToNextPlace();
  });

  viewer.mousedown(function(event) {
    mouseButtonDown = true;
    lastClientX = event.clientX;
    lastClientY = event.clientY;
  });

  viewer.mouseup(function() {
    mouseButtonDown = false;
  });

  viewer.mousemove(function(event) {
    if (mouseButtonDown) {
      var enableX = (USE_TRACKER || VRState !== null) ? 0 : 1;
      BaseRotationEuler.set(
        angleRangeRad(BaseRotationEuler.x + (event.clientY - lastClientY) * MOUSE_SPEED * enableX),
        angleRangeRad(BaseRotationEuler.y + (event.clientX - lastClientX) * MOUSE_SPEED),
        0.0
      );
      lastClientX = event.clientX;
      lastClientY = event.clientY;
      BaseRotation.setFromEuler(BaseRotationEuler, 'YZX');
    }
  });

  // Gamepad
  // ---------------------------------------
  gamepad = new Gamepad();
  gamepad.bind(Gamepad.Event.CONNECTED, function(device) {
    console.log("Gamepad CONNECTED")
  });

  gamepad.bind(Gamepad.Event.BUTTON_DOWN, function(e) {
    if (e.control == "DISABLED_FACE_2") {
      $('.ui').toggle(200);
    }
  });

  // Look for tick event so that we can hold down the FACE_1 button and
  // continually move in the current direction
  gamepad.bind(Gamepad.Event.TICK, function(gamepads) {
    // Multiple calls before next place has finished loading do not matter
    // GSVPano library will ignore these
    if (gamepads[0].state["DISABLED_FACE_1"] === 1) {
      moveToNextPlace();
    }
  });

  gamepad.bind(Gamepad.Event.AXIS_CHANGED, function(e) {
    // ignore deadzone
    var value = e.value;
    if (value < -DEADZONE) value = value + DEADZONE;
    else if(value > DEADZONE) value = value - DEADZONE;
    else value = 0;

    if (e.axis == "LEFT_STICK_X") {
      gamepadMoveVector.y = -value*GAMEPAD_SPEED;
    }
    else if (e.axis == "LEFT_STICK_Y") {
      gamepadMoveVector.x = -value*GAMEPAD_SPEED;
    }
  });

  if (!gamepad.init()) {
    //console.log("Gamepad not supported");
  }
}

function initVR() {
  vr.load(function(error) {
    if (error) {
      //console.warn('VR error: ' + error.toString());
      return;
    }

    VRState = new vr.State();
    if (!vr.pollState(VRState)) {
      //console.warn('NPVR plugin not found/error polling');
      VRState = null;
      return;
    }

    if (!VRState.hmd.present) {
      //console.warn('oculus rift not detected');
      VRState = null;
      return;
    }
    BaseRotationEuler.x = 0.0;
  });
}
$(document).ready(function(){
init();
animate();
});
</script>
</head>
<body>
<div id="viewer"></div>
</body>
</html>
